name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # í”„ë¡œì íŠ¸ ê²½ë¡œ ì°¾ê¸°
          if [ -d "/home/ubuntu/LET_AI_SERVER" ]; then
            cd /home/ubuntu/LET_AI_SERVER
          elif [ -d "/home/ubuntu/let-ai" ]; then
            cd /home/ubuntu/let-ai
          elif [ -d "~/LET_AI_SERVER" ]; then
            cd ~/LET_AI_SERVER
          else
            echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la
            echo "í™ˆ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la ~
            exit 1
          fi
          
          echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git reset --hard origin/main
          
          # .env íŒŒì¼ì´ ì—†ë‹¤ë©´ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ ê¸°ì¡´ ì‚¬ìš©)
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. EC2ì— ì§ì ‘ ìƒì„±í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          docker-compose down --remove-orphans
          docker-compose build --no-cache
          docker-compose up -d
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 15
          if curl -f http://127.0.0.1:8001/health; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸"
            docker-compose logs --tail=50
            exit 1
          fi