name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # í”„ë¡œì íŠ¸ ê²½ë¡œ ì°¾ê¸°
          if [ -d "/home/ubuntu/LET_AI_SERVER" ]; then
            PROJECT_DIR="/home/ubuntu/LET_AI_SERVER"
          elif [ -d "/home/ubuntu/let-ai" ]; then
            PROJECT_DIR="/home/ubuntu/let-ai"
          elif [ -d "~/LET_AI_SERVER" ]; then
            PROJECT_DIR="~/LET_AI_SERVER"
          else
            echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la
            echo "í™ˆ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la ~
            exit 1
          fi
          
          cd $PROJECT_DIR
          echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (public repoì¸ ê²½ìš°)
          git pull origin main || {
            echo "âŒ Git pull ì‹¤íŒ¨. Repositoryê°€ privateì´ë©´ SSH í‚¤ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ publicìœ¼ë¡œ ë§Œë“œì„¸ìš”."
            echo "í˜„ì¬ ì›ê²© URL: $(git remote get-url origin)"
            exit 1
          }
          
          # docker-compose.yml ìœ„ì¹˜ í™•ì¸
          if [ -f "docker-compose.yml" ]; then
            echo "âœ… docker-compose.yml ì°¾ìŒ"
          elif [ -f "ai_exercise_service/docker-compose.yml" ]; then
            echo "âŒ docker-compose.ymlì´ ë£¨íŠ¸ì— ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            ls -la
            exit 1
          else
            echo "âŒ docker-compose.ymlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            ls -la
            exit 1
          fi
          
          # .env íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. EC2ì— ì§ì ‘ ìƒì„±í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          
          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          docker-compose down --remove-orphans
          docker-compose build --no-cache
          docker-compose up -d
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sleep 15
          if curl -f http://127.0.0.1:8001/health; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸"
            docker-compose logs --tail=50
            exit 1
          fi